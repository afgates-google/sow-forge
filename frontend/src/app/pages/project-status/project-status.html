<div class="status-container">
  <!-- Show loading indicator only while fetching initial data -->
  <div *ngIf="isLoading" class="loading-indicator">
    <p>Loading project details...</p>
  </div>

  <!-- Main content, shown only after initial load and if a project exists -->
  <div *ngIf="!isLoading && project">
    <div class="project-header">
      <div *ngIf="!isEditingProjectName; else editProjectNameBlock">
        <h2>
          SOW Project: {{ project.projectName }}
          <span class="material-symbols-outlined edit-icon" (click)="startProjectNameEdit()">edit_square</span>
        </h2>
      </div>
      <ng-template #editProjectNameBlock>
        <div class="edit-form">
          <input type="text" [(ngModel)]="project.projectName" (keyup.enter)="saveProjectName()" (keyup.escape)="cancelProjectNameEdit()">
          <button class="save-btn" (click)="saveProjectName()"><span class="material-symbols-outlined">check</span></button>
          <button class="cancel-btn" (click)="cancelProjectNameEdit()"><span class="material-symbols-outlined">close</span></button>
        </div>
      </ng-template>
    </div>
    <p><strong>Overall Status:</strong> <span class="status-tag">{{ isAnalysisComplete ? 'ANALYSIS_COMPLETE' : project.status }}</span></p>

    <!-- In project-status.component.html -->
    
    <h3>Source Documents</h3>
<p>Monitoring analysis progress. This page will auto-refresh every 5 seconds.</p>

<div class="documents-list-container">
  <!-- Header Row for Titles -->
  <div class="list-header">
    <div class="header-left">
      <span>Document Name</span>
      <span>Category</span>
    </div>
    <div class="header-right">
      <span>Status</span>
      <span>Actions</span>
    </div>
  </div>

  <!-- Data Rows (Looped) -->
  <div class="document-row" *ngFor="let doc of project.sourceDocuments">
    
    <!-- Group 1: Name & Category (Left Aligned) -->
    <div class="col-left">
      <!-- Name (with inline edit) -->
      <div class="name-container">
        <div *ngIf="editingDocId !== doc.id; else editDocBlock">
          <div class="name-view">
            <!-- The document name is no longer a link -->
            <span class="file-name">{{ doc.displayName }}</span>
          
            <!-- Group the icons together -->
            <div class="icon-actions">
              <!-- NEW: "View Analysis" icon, shown only on success -->
              <a *ngIf="doc.status === 'ANALYZED_SUCCESS'" 
                 [routerLink]="['/projects', project.id, 'documents', doc.id]"
                 class="action-icon-link"
                 title="View Analysis Results">
                <span class="material-symbols-outlined">plagiarism</span>
              </a>
          
              <!-- The existing "Edit Name" icon -->
              <span class="material-symbols-outlined edit-icon" (click)="startDocNameEdit(doc)">edit_square</span>
            </div>
          </div>
        </div>
        <ng-template #editDocBlock>
          <div class="edit-form-inline">
            <input type="text" [(ngModel)]="doc.displayName" (keyup.enter)="saveDocChanges(doc)" (keyup.escape)="cancelDocNameEdit(doc)">
            <button class="save-btn" (click)="saveDocChanges(doc)"><span class="material-symbols-outlined">check</span></button>
            <button class="cancel-btn" (click)="cancelDocNameEdit(doc)"><span class="material-symbols-outlined">close</span></button>
          </div>
        </ng-template>
      </div>
      
      <!-- Category Dropdown -->
      <div class="category-container">
        <select [(ngModel)]="doc.category" (change)="saveDocChanges(doc)" class="category-select">
          <option *ngFor="let cat of documentCategories" [value]="cat">{{ cat }}</option>
        </select>
      </div>
    </div>

    <!-- Group 2: Status & Actions (Right Aligned) -->
    <div class="col-right">
      <div class="status-container-inner">
        <span class="status-pill" [ngClass]="doc.status.toLowerCase().replace('_', '-')">{{ doc.status }}</span>
      </div>
      <div class="actions-container">
        <button class="action-btn-icon" (click)="triggerRegenerate(doc)" title="Regenerate Analysis">
          <span class="material-symbols-outlined">restart_alt</span>
        </button>
      </div>
    </div>
  </div>
    
    <!-- Add this new section to project-status.html -->

    <div *ngIf="project.generatedSows && project.generatedSows.length > 0" class="generated-sows-section">
      <h3>Generated Statements of Work</h3>
      <div class="sow-list">
        <div class="sow-item" *ngFor="let sow of project.generatedSows">
          <div class="sow-info">

            <!-- This is the new conditional block for view/edit mode -->
            <div *ngIf="editingSowId !== sow.id; else editSowNameBlock">
              <!-- View Mode -->
              <div class="name-view">
                <span class="sow-name">SOW: {{ sow.templateName }}</span>
                <span class="material-symbols-outlined edit-icon" (click)="startSowNameEdit(sow)" title="Rename SOW">
                  edit_square
                </span>
              </div>
            </div>

            <!-- Edit Mode -->
            <ng-template #editSowNameBlock>
              <div class="edit-form-inline">
                <input type="text" [(ngModel)]="sow.templateName" (keyup.enter)="saveSowName(sow)" (keyup.escape)="cancelSowNameEdit(sow)">
                <button class="save-btn" (click)="saveSowName(sow)" title="Save"><span class="material-symbols-outlined">check</span></button>
                <button class="cancel-btn" (click)="cancelSowNameEdit(sow)" title="Cancel"><span class="material-symbols-outlined">close</span></button>
              </div>
            </ng-template>

            <span class="sow-meta">Generated on: {{ sow.createdAt | date:'short' }} | Template: {{ sow.templateId }}</span>
          </div>
          <div class="sow-actions">
            <!-- NEW LINK: To the refactored editor -->
            <a [routerLink]="['/projects', project.id, 'sows', sow.id, 'editor']" class="btn-secondary">
              View SOW
            </a>
            <!-- If Google Doc exists, show a link to it -->
            <a *ngIf="sow.googleDocUrl" [href]="sow.googleDocUrl" target="_blank" class="btn-primary">
              View Google Doc
            </a>
            
            <!-- THIS IS THE NEW BUTTON -->
            <button class="action-btn-icon" (click)="deleteSow(sow)" title="Delete SOW">
              <span class="material-symbols-outlined">delete</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MOVED TO BOTTOM: The SOW generation controls -->
    <div class="generation-controls">
      <h3>Generate New Statement of Work</h3>
      <div class="control-group">
        <label for="template">Select SOW Template:</label>
        <select id="template" [(ngModel)]="selectedTemplateId">
          <option *ngFor="let template of templates" [value]="template.id">{{ template.name }}</option>
        </select>
      </div>
      <button (click)="triggerSowGeneration()" [disabled]="!selectedTemplateId || isGenerating" class="btn-primary">
        {{ isGenerating ? 'Generating SOW...' : 'Generate SOW' }}
      </button>
    </div>
  </div>

  <!-- Show error message if something went wrong -->
  <div *ngIf="errorMessage" class="error-message">
    <p>Error: {{ errorMessage }}</p>
  </div>
</div>